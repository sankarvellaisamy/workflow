package com.plcs.base;

import io.github.bonigarcia.wdm.WebDriverManager;
import org.junit.After;
import org.junit.AfterClass;
import org.junit.BeforeClass;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.edge.EdgeOptions;
import org.openqa.selenium.remote.RemoteWebDriver;
import org.openqa.selenium.chromium.ChromiumDriver;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.edge.EdgeDriver;

import java.io.IOException;
import java.io.InputStream;
import java.time.Duration;
import java.util.*;
import java.util.stream.Collectors;

/**
 * BaseClass: Initializes WebDriver (Chrome/Edge) and injects custom headers
 * via Chrome DevTools Protocol (CDP) using executeCdpCommand.
 *
 * Headers are read from config.properties with prefix "header."
 *
 * Example config.properties:
 *   browser=chrome
 *   plcsQaUrl=https://your-app-url
 *   header.DDP_FTOGGLE_22608_USER=sgujral
 *   header.DDP_FTOGGLE_22608_GROUPS=DyGrp-ID-VisaEmployee|DyGrp-ID-VisaNonEmployee
 *   header.X-API-Key=SVC_FTOGGLE_DEV:06Y7TF5F7B2W:F^m
 *   header.Referer=https://abc.visa.com
 *   header.Origin=https://abc.visa.com
 */
public class BaseClass {

    protected static WebDriver driver;
    protected static Properties config = new Properties();
    private static final String CONFIG_FILE = "/config.properties";

    @BeforeClass
    public static void setUp() {
        loadConfig();
        String browser = Optional.ofNullable(config.getProperty("browser")).orElse("chrome").trim().toLowerCase();

        // Initialize driver based on browser identifiers
        if (isChromeVariant(browser)) {
            initChromeDriver();
        } else if (isEdgeVariant(browser)) {
            initEdgeDriver();
        } else {
            throw new IllegalArgumentException("Browser \"" + browser + "\" not supported (supported: chrome, edge, msedge, chromium, edge-chromium)");
        }

        // maximize & timeouts
        driver.manage().window().maximize();
        driver.manage().timeouts().implicitlyWait(Duration.ofSeconds(10));

        // Load headers from config and inject for Chromium-based drivers
        Map<String, String> headers = loadHeadersFromConfig();
        if (!headers.isEmpty()) {
            injectHeadersIfChromium(headers);
        }

        // Navigate to configured URL
        String url = config.getProperty("plcsQaUrl");
        if (url != null && !url.isBlank()) {
            driver.get(url);
        }
    }

    @AfterClass
    public static void tearDown() {
        if (driver != null) {
            try {
                driver.quit();
            } catch (Exception ignored) { }
        }
    }

    // ----------------------
    // Helper methods
    // ----------------------

    private static boolean isChromeVariant(String browser) {
        return browser.equals("chrome") || browser.equals("chromium");
    }

    private static boolean isEdgeVariant(String browser) {
        return browser.equals("edge") || browser.equals("msedge") || browser.equals("edge-chromium");
    }

    private static void initChromeDriver() {
        // Use WebDriverManager to manage driver binaries (optional)
        WebDriverManager.chromedriver().setup();

        ChromeOptions options = new ChromeOptions();
        options.addArguments("--disable-blink-features=AutomationControlled");
        options.addArguments("--start-maximized");

        driver = new ChromeDriver(options);
    }

    private static void initEdgeDriver() {
        // Use WebDriverManager for Edge driver (optional)
        WebDriverManager.edgedriver().setup();

        EdgeOptions options = new EdgeOptions();
        options.addArguments("--disable-blink-features=AutomationControlled");
        options.addArguments("--start-maximized");

        driver = new EdgeDriver(options);
    }

    /**
     * Loads all properties from /config.properties on classpath.
     * If you already have a configReader class, you can replace this with it.
     */
    private static void loadConfig() {
        try (InputStream is = BaseClass.class.getResourceAsStream(CONFIG_FILE)) {
            if (is == null) {
                throw new RuntimeException("Could not find " + CONFIG_FILE + " on classpath");
            }
            config.load(is);
        } catch (IOException e) {
            throw new RuntimeException("Failed to load config file " + CONFIG_FILE, e);
        }
    }

    /**
     * Reads all keys that start with header. and returns a Map<HeaderName, HeaderValue>
     */
    private static Map<String, String> loadHeadersFromConfig() {
        return config.stringPropertyNames().stream()
                .filter(k -> k.startsWith("header."))
                .collect(Collectors.toMap(
                        k -> k.substring("header.".length()),
                        config::getProperty
                ));
    }

    /**
     * Inject headers only if driver is Chromium-based (ChromeDriver or EdgeDriver).
     * Uses executeCdpCommand which is stable across many Selenium versions.
     */
    private static void injectHeadersIfChromium(Map<String, String> headers) {
        if (driver == null) return;

        if (driver instanceof ChromiumDriver) {
            ChromiumDriver chromium = (ChromiumDriver) driver;
            // Enable Network (best practice)
            try {
                // Some Selenium versions support "Network.enable" via executeCdpCommand
                Map<String, Object> enableParams = new HashMap<>();
                enableParams.put("maxTotalBufferSize", 0);
                chromium.executeCdpCommand("Network.enable", enableParams);

                // setExtraHTTPHeaders expects an object with "headers" -> {name:value}
                Map<String, Object> headersParam = new HashMap<>();
                headersParam.put("headers", headers);
                chromium.executeCdpCommand("Network.setExtraHTTPHeaders", headersParam);

                // Optionally: log success
                System.out.println("Injected custom headers via CDP: " + headers.keySet());
            } catch (Exception e) {
                System.err.println("Failed to inject headers via CDP: " + e.getMessage());
                // do not fail the whole test initialization just because header injection failed
            }
        } else {
            System.out.println("Driver is not Chromium-based; header injection skipped.");
        }
    }

    // Expose driver for tests
    public WebDriver getDriver() {
        return driver;
    }
}
